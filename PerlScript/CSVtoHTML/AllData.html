<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Automated Test Times</title>
		<link href="layout.css" rel="stylesheet" type="text/css">
		<script language="javascript" type="text/javascript" src="_images/jquery.js"></script>
		<script language="javascript" type="text/javascript" src="_images/jquery.flot.js"></script>
		<script language="javascript" type="text/javascript" src="_images/jquery.flot.time.js"></script>
		<script language="javascript" type="text/javascript" src="_images/jquery.flot.resize.js"></script>
		<script language="javascript" type="text/javascript" src="_images/jquery.flot.crosshair.js"></script>
		<script language="javascript" type="text/javascript" src="_images/jquery.flot.navigate.js"></script>

		<style>
			body {
				background: #f0f0f0;
				font: 10pt sans-serif;
				color: #000000;
			}
			#placeholder {
				width:100%;
				height:500px;
				margin: auto;
				margin-bottom: 5px;
			}
			#tooltip {
				background: rgba(240,240,240,0.6);
				border-radius: 5px;
				padding: 5px;
				font: 9pt sans-serif;
				color: #000000;
			}
			#datalist {
				width: 700px;
				overflow: auto;
				margin: auto;
				border: 1px solid #404040;
				border-radius: 5px;
				padding: 5px;
				font: 9pt sans-serif;
				color: #000000;
			}
		</style>
	</head>

	<body>
		<h1>Automated Processes - Relative Times</h1>
		<div id="placeholder"></div>

		<div id="criteria" style="width: 400px; float: right;">
			<b>Criteria</b><br>
			<ul>
				<li>p.runs: Number of times the process has been run</li>
				<li>p.min: Minimum execution time (seconds)</li>
				<li>p.max: Maximum execution time (seconds)</li>
				<li>p.avg: Average execution time (seconds)</li>
				<li>p.last: Latest execution time (seconds)</li>
			</ul>
			<b>Condition</b>: <input type="text" id="condition" name="condition" value="p.avg > 10 && p.last > 1.1*p.avg" size="40">
			<div style="text-align: center;">
				<input type="button" name="checkall" value="Update" onclick="checknotable(document.choices, document.getElementById('condition').value)">
				<input type="button" name="uncheckall" value="None" onclick="checkall(document.choices, false)">
				<input type="button" name="checkall" value="All" onclick="checkall(document.choices, true)">
			</div>
		</div>
		
		<div id="datalist" style="">
			<form name="choices" id="choices">
			</form>
		</div>
		
		<script type="text/javascript">
			var datasets = {
			};

			function ResetHeight()
			{
				var text = document.getElementById('datalist');
				var foot = document.getElementById('footer');
				if (!text) return;
				
				var minimum =  300;
				var maximum = 1000;
				var adjust  = document.documentElement.clientHeight - (foot.offsetTop + foot.clientHeight + 2);
				
				if (adjust)
					{
						if ((adjust > 0) && (text.clientHeight < maximum))
							{
								// All in one shot
								adjust = Math.min(adjust, maximum-text.clientHeight);
								text.style.height = (text.clientHeight-18 + adjust) + "px";
								
								// Smooth resize
								//text.style.height = (text.clientHeight-2 + (Math.max(1,Math.round(adjust/10)))) + "px";
								//resizeTimer = setTimeout('ResetHeight()', 10);
							}
						else if ((adjust < 0) && (text.clientHeight > minimum))
							{
								// All in one shot
								adjust = Math.max(adjust, minimum-text.clientHeight);
								text.style.height = (text.clientHeight-18 + adjust) + "px";
								
								// Smooth resize
								//text.style.height = (text.clientHeight-2 + (Math.min(-1,Math.round(adjust/10)))) + "px";
								//resizeTimer = setTimeout('ResetHeight()', 10);
							}
					}
			}
			window.addEventListener('load', ResetHeight, false);
			window.addEventListener('resize', ResetHeight, false);

			function checkall(fmobj, state)
			{
				for (var i=0;i<fmobj.elements.length;i++)
					{
						var e = fmobj.elements[i];
						if ((e.type=='checkbox') && (!e.disabled))
							e.checked = state;
					}

				$("label").css("backgroundColor", "transparent");
				plotAccordingToChoices();
			}

			function checknotable(fmobj, test)
			{
				for (var i=0;i<fmobj.elements.length;i++)
					{
						var e = fmobj.elements[i];
						if ((e.type=='checkbox') && (!e.disabled))
						{
							var n = e.name;
							n = n.replace('&','&amp;');
							var p = datasets[n];
							if (test)
								e.checked = eval(test);
							else
								e.checked = p.avg > 10 && p.last < 0.9*p.avg;
						}
					}

				$("label").css("backgroundColor", "transparent");
				plotAccordingToChoices();
			}

			var plot;
			var choiceContainer = $("#choices");
			var index = 0;
			$.each(datasets, function(key, val) {
					val.id = "data"+(++index);
					choiceContainer.append('<input type="checkbox" ' + ' name="' + key + '" id="' + val.id + '">' + '<label for="' + val.id + '">' + val.label + '</label><br/>');
				});
			choiceContainer.find("input").click(plotAccordingToChoices);
        
			var updateLegendTimeout = null;
			var latestPosition = null;
		
			$("#placeholder").bind("plothover",  function (event, pos, item) {
					latestPosition = pos;
					if (!updateLegendTimeout) {
						updateLegendTimeout = setTimeout(updateLegend, 50);
					}
				});

			function updateLegend() {
				updateLegendTimeout = null;
				var pos = latestPosition;
				var axes = plot.getAxes();
				if (pos.x < axes.xaxis.min || pos.x > axes.xaxis.max || pos.y < axes.yaxis.min || pos.y > axes.yaxis.max) {
					return;
				}
				var x, y, i, j, dataset = plot.getData();
				for (i = 0; i < dataset.length; ++i) {
					var series = dataset[i];
					// Find the nearest points, x-wise
					for (j = 0; j < series.data.length; ++j) {
						if (series.data[j][0] > pos.x) {
							if ((series.data[j][0] - pos.x) < (pos.x - series.data[j-1][0])) {
								x = series.data[j][0];
								y = series.data[j][1];
							}
							else {
								x = series.data[j-1][0];
								y = series.data[j-1][1];
							}
							break;
						}
					}
					
					var lab = (y/100*series.last).toFixed(2)+"s. ("+y.toFixed(0)+"%)"; // (new Date(x)).toLocaleString()
					$("label[for='" + series.id + "']").text(series.label + " - " + lab);
					$("label[for='" + series.id + "']").css('backgroundColor', series.color);
				}
			}

			// .scrollTo - Plugin
			$.fn.scrollTo = function( target, options, callback ) {
				if(typeof options == 'function' && arguments.length == 2){
					callback = options;
					options = target;
				}
				var settings = $.extend({
						scrollTarget  : target,
						offsetTop     : 5,
						duration      : 500,
						easing        : 'swing'
					}, options);
				return this.each(function(){
						var scrollPane = $(this);
						var scrollTarget = (typeof settings.scrollTarget == "number") ? settings.scrollTarget : $(settings.scrollTarget);
						var scrollY = (typeof scrollTarget == "number") ? scrollTarget : scrollTarget.offset().top - scrollPane.offset().top + scrollPane.scrollTop() - settings.offsetTop;
						scrollPane.animate({scrollTop : scrollY }, settings.duration, settings.easing, function(){
								if (typeof callback == 'function') { callback.call(this); }
							});
					});
			}
				
			$("#placeholder").bind("plotclick", function (event, pos, item) {
					if (item) {
						var d = new Date(item.datapoint[0]);
						showTooltip(item.pageX, item.pageY, item.series.color, '<b>'+item.series.label+'</b><br>'+d.toString());
						$("#datalist").scrollTo("#"+item.series.id);
					}
					else {
						$("#tooltip").remove();
					}
				});

			function showTooltip(x, y, color, contents) {
				$("#tooltip").remove();
				$('<div id="tooltip">' + contents + '</div>').css( {
						position: 'absolute',
							display: 'none',
							border: '2px solid ' + color,
							top: y + 5,
							left: x + 5,
							}).appendTo("body").fadeIn(200);
			}

			function plotAccordingToChoices() {
				var data = [];
				
				choiceContainer.find("input:checked").each(function () {
						var key = $(this).attr("name");
						if (key && datasets[key])
							data.push(datasets[key]);
					});
				
				plot = $.plot($("#placeholder"), data, {
						series: {
							lines: { show: true, lineWidth: 1 },
							points: { show: true, lineWidth: 2, radius: 2 }
						},
						grid: { clickable: true, backgroundColor: '#ffffff', borderWidth: 1, hoverable: true },
						crosshair: { mode: "x" },
						xaxis: {
									mode: "time",
									timeformat: "%Y-%m-%d"
								},
						yaxis: {
									transform: function (v) { if (v == 0) v = 10; return Math.log(v); },
									inverseTransform: function (v) { return Math.exp(v); }
								},
						legend: { show: false },
						zoom: { interactive: true },
						pan: { interactive: true }
					});
			}

			checknotable(document.choices, document.getElementById('condition').value);
		</script>
		<div id="footer" style="height: 0px;"></div>
	</body>
</html>
